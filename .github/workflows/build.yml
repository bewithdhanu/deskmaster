name: Build and Release DeskMaster

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v2.0.0)'
        required: true
        default: 'v2.0.0'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build React applications
        run: npm run build-app

      - name: Build for macOS (Apple Silicon)
        run: npx electron-builder --mac --arm64 --publish=never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build for macOS (Intel)
        run: npx electron-builder --mac --x64 --publish=never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds-${{ github.event.inputs.version || github.event.release.tag_name }}
          path: |
            dist/*.dmg
            dist/*.dmg.blockmap
          retention-days: 30

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version || github.event.release.tag_name }}
          name: DeskMaster ${{ github.event.inputs.version || github.event.release.tag_name }}
          body: |
            ## DeskMaster ${{ github.event.inputs.version || github.event.release.tag_name }}
            
            ### üöÄ What's New
            - Desktop productivity tool with system monitoring
            - World clocks with multiple timezone support
            - Real-time system statistics in tray
            - Modern React + Tailwind CSS interface
            - macOS native integration
            
            ### üì¶ Downloads
            
            #### macOS
            - **Apple Silicon (M1/M2/M3)**: `DeskMaster-*-arm64.dmg`
            - **Intel Mac**: `DeskMaster-*-x64.dmg`
            
            ### üîß Installation
            1. Download the appropriate DMG file for your Mac
            2. Open the DMG file and drag DeskMaster to Applications
            3. Launch DeskMaster from Applications or Spotlight
            4. Enjoy your desktop productivity tool!
            
            ### üêõ Issues
            Report issues at: https://github.com/bewithdhanu/deskmaster/issues
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.dmg.blockmap
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}